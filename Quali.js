let tileSize = 10
let map1, map2, map3, trackLimit, timingLine, testing, start, player, track, carImg1, carImg2, carImg3, carImg4, cars, mapSelected, slowArea, startSlowArea, slowed
let resButton
let maps = [map1, map2, map3]
let debugInput = "map1"
let gear = 1
let lapStarted = false
let sessionStarted = false
let sessionComplete = false
let lap = 1
let laptime = 0
let fastestLap = null
let fastestOnLap = 1
let qLaps = []
let fastestLapInfo = []
let hasStalled = false
let Paused = false
let PST = 0
let endGame = false
let timestartheld
let timeRemaining = 60
let countdown = 30*60
let carImages
let images = [carImages]

function preload(){
    carImg1 = loadImage('images/cars/cars_racer (1).png')
    carImg2 = loadImage('images/cars/cars_racer (2).png')
    carImg3 = loadImage('images/cars/cars_racer (3).png')
    carImg4 = loadImage('images/cars/cars_racer (4).png')
    carImages = [carImg1, carImg2, carImg3, carImg4]
}
function setup() {
    // Create Canvas and set background and frameRate
    createCanvas(windowWidth, windowHeight);
    background(255);
    frameRate(60);
    defaultFont = textFont()
    mapSelected = random(["map1", "map2", "map3", "map4"])
    // Create tile types





    trackLimit = new Group()
    trackLimit.color = "red"
    trackLimit.tile = 'b'
    trackLimit.collider = 's' //Collisions with the track limit will be processed as static
    trackLimit.w = tileSize
    trackLimit.h = tileSize

    player = new Sprite()
    player.collider = 'd'
    player.tile = 'x'
    player.color = 'yellow'
    player.image = random(carImages)
    player.scale = 0.045
    player.direction = Math.PI / 2
    if (mapSelected == "map2") {
        player.direction = -90
    }
    player.w = 11
    player.h = 6

    track = new Group()
    track.tile = '.'
    track.w = tileSize;
    track.h = tileSize;
    track.collider = "n";
    track.color = "#5a5348";
    track.visible = true;

    start = new Group()
    start.collider = "n"
    start.tile = "s"
    start.visible = true
    start.w = tileSize
    start.h = tileSize
    player.overlapping(start, function () {
        StartLineOverlap()
    })

    timingLine = new Group();
    timingLine.collider = "n";
    timingLine.tile = "t";
    timingLine.visible = false;
    timingLine.color = "orange";
    timingLine.w = tileSize;
    timingLine.h = tileSize;
    player.overlapping(timingLine, function () {
        TimingOverlap()
    })

    testing = new Group();
    testing.collider = "n";
    testing.tile = "=";
    testing.visible = true;
    testing.color = "orange";
    testing.w = tileSize;
    testing.h = tileSize;

    slowArea = new Group()
    slowArea.collider = "n"
    slowArea.tile = "B"
    slowArea.color = "#969292"
    slowArea.w = tileSize
    slowArea.h = tileSize
    slowArea.visible = false

    startSlowArea = new Group()
    startSlowArea.collider = "n"
    startSlowArea.tile = "S"
    startSlowArea.color = "#969292"
    startSlowArea.visible = false
    startSlowArea.w = tileSize
    startSlowArea.h = tileSize
    player.overlapping(startSlowArea, function () {
        StartLineOverlap()
    })


    switch (mapSelected[3]) {
        case "1":
            map1 = new Tiles(
                [
                    ".................................................................",
                    ".....b...........................................................",
                    "...bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb.............",
                    ".bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb............",
                    ".bbbb.......................s..................bbbbbb............",
                    ".bbb........................s....................bbbbb...........",
                    ".bb.........................s.....................bbbbb..........",
                    ".b..........................s......................bbbb..........",
                    ".b..................x.......s......................bbbb..........",
                    ".b..........................s......................bbbb..........",
                    ".b.....bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".b.....b....................................b......bbb...........",
                    ".bb...bb....................................b......bbb...........",
                    "..b...b.....................................b......bbb...........",
                    "..b...b.....................................b......bbb...........",
                    "..b...b.....................................b......bbb...........",
                    ".bb...bb....................................b.....bbbb...........",
                    ".b.....b...................................b.....bbbb............",
                    ".b.....b..................................b.....bbbb.............",
                    ".b.....b..................................b.....bbb..............",
                    ".b.....b..................................b.....bbb..............",
                    ".b.....b..................................b.....bbb..............",
                    ".b.....b..................................b.....bbb..............",
                    ".b.....b..................................b.....bbbb.............",
                    ".b.....b.................................bb......bbbb............",
                    ".b.....b..................................bb.....bbbb............",
                    ".b.....b...................................bb....bbbb............",
                    ".b.....bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb....bb.....bb............",
                    ".b.....bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb..bb.....bb............",
                    ".b.....................................bbbb.bb.....bb............",
                    ".bb.....................................bbb.bb.....bb............",
                    "..b.......................................b.bb.....bbb...........",
                    "..bb......................................b.bb.....bb............",
                    "...bbb....................................b.bb.....bb............",
                    ".....bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb......b.bb.....bb............",
                    "................................bbbb......b.bb.....bbbbbbbbbbbbb.",
                    "................................bbbb......b.bb.....bbbbbbbbbbbbbb",
                    ".................................bbb......b.bb...............bbbb",
                    "..................................bb......b.bb................bbb",
                    "..................................bb......b.bb................bbb",
                    "..................................bb......b.bbb................bb",
                    "..................................bb......b.bbbbb..............bb",
                    "..................................bb......b.bbbbbbbbbbbbb......bb",
                    "..................................bb......b.bbbbbbbbbbbbb......bb",
                    ".................................bbb.....bb.bbbbbbbbbbbbb......bb",
                    "..............................bbbbb.....bbb....bbbbbbbbbb......bb",
                    "..............................bbbb.....bbbb......bbbbbbbb......bb",
                    "..............................bbbb.....bbbbbbbbbbbbbbbbbb......bb",
                    "..............................bbbb.....bbbbbbbbbbbbbbbbbb......bb",
                    "..............................bbbb.....bbbbbbbbbbbbbbbbbb......bb",
                    "..............................bbbb..............t..............bb",
                    "..............................bbbb..............t..............bb",
                    "..............................bbbb..............t..............bb",
                    "..............................bbbbb.............t.............bbb",
                    ".............................bbbbbbbb...........t...........bbbbb",
                    "..............................bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                    "...............................bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb",
                ],
                0,
                0,
                tileSize,
                tileSize
            );
            break
        case "2":
            map2 = new Tiles(
                [
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "..........................................................................bbbbbbbbb.................",
                    ".....................................................................bbbbbb.......bb................",
                    "....................................................................bb.............b................",
                    "....................bbbbbbbbb.....................................bbb..............b..bbbbbb........",
                    "....................bBBBBBBBb....................................bb................b.bb....bbb......",
                    "....................bBBBBBBBb....................................b........bbb......b.b.......bb.....",
                    "....................bBBBBBBBb.............bbbbbbb................b.......bbbb......b.b........bb....",
                    "....................bBBBBBBBBb....bbbbbbbbb.....bbb..............b......bbbb......bb.b.........b....",
                    "....................bBBBBBBBBbbbbbb...............bbb............bb.....bbbb......b..b.........b....",
                    "....................bBBBBBBB........................bb............b.....bb.......bb..b.........b....",
                    "....................bBBBBB............................bb...........b....bb.......b...b.........b....",
                    "....................bBBB...............................bbb........bb....bb......bb..bb.........b....",
                    "....................bBB..................................bb......bb.....bb......b...b..........b....",
                    "....................b.....................................bbbb..bb......bb......b..bb....bb....b....",
                    "...................bb........................................bbb........bb......b.bb.....bb....b....",
                    "...................b...................................................bbb......bbb......b.....b....",
                    "...................b...................bbbbbbbb........................b.bb.............bb....bb....",
                    "..................bb................bbbb......bbb......................b..b............bbb....b.....",
                    "..................b.............bbbbb...........bbbb...................b..bb..........bbb.....b.....",
                    ".................bb..........bbb...................bbbb..............bbb...bb........bb.b.....b.....",
                    ".................b.......bbbbb.........................bbbb......bbbbb......bbb...bbb..b......b.....",
                    "................bb......bb.................................bbbbbbb............bbbbb....b......b.....",
                    "................b.......b.............................................................bb.....bb.....",
                    "................b.......b.............................................................b......b......",
                    "...............bb.......b.............................................................b......b......",
                    "...............b.......bb.............................................................b......b......",
                    "..............bb.......b..............................................................b......b......",
                    "..............b........b..............................................................b.....bb......",
                    "..............b........b.............................................................bb.....b.......",
                    ".............bb........b.............................................................b......b.......",
                    ".............b.........b.............................................................b......b.......",
                    "............bb........bb............................................................bb......b.......",
                    "............b........bb.............................................................b......bb.......",
                    "............b........b.............................................................bb......b........",
                    "...........bb........b.............................................................b.......b........",
                    "...........b.........b............................................................bb......bb........",
                    "...........b........bb...........................................................bb.......b.........",
                    "...........b........b...........................................................bb.......b..........",
                    "..........b........bb...........................................................b........b..........",
                    "..........b........b...........................................................bb.......bb..........",
                    "..........bsss....bb..........................................................b.........b...........",
                    "..........b..sssssb..........................................................bb........b............",
                    ".........b........b.........................................................b.........bb............",
                    ".........b.......bb.......................................................bbb........bb.............",
                    ".........b.......b.......................................................bb.........bb..............",
                    "........bb.......b.....................................................bbb.........bb...............",
                    "........b.......bb...................................................bbb.........bbb................",
                    "........b.......b.................................................bbbbt.........bb..................",
                    "........b.......b...........................bbbbbbbbbbbbbb......bbb...t.........b...................",
                    "........b...x...b...................bbbbbbbbb.............b....bb.....tt.......bb...................",
                    "........b.......b.................bbb......................b...b.......t......bb....................",
                    "........b.......b...............bbb.........................b..b.......t....bbb.....................",
                    "........b.......b.............bbb............................b.b.......t.bbbb.......................",
                    "........b.......b............bb............bbbbbbbbbbbbbb.....bb....bbbbbb..........................",
                    "........b.......b...........bb.........bbbbb............bb..........b...............................",
                    "........b.......b...........b........bbb.................bb.........b...............................",
                    "........b.......b..........bb.......b.....................b.........b...............................",
                    "........b.......bbb........b.......bb.....................bb........b...............................",
                    "........b.........b.......b.......bb.......................bbbbbbbbbb...............................",
                    "........bb........b......bb......bb.................................................................",
                    ".........b........bb.....b.......b..................................................................",
                    ".........b.........b.....b.......b..................................................................",
                    ".........b.........b....bb......bb..................................................................",
                    ".........b.........b....b.......b...................................................................",
                    ".........b.........b....b.......b...................................................................",
                    ".........b.........b....b.......b...................................................................",
                    ".........b.........b....b.......b...................................................................",
                    "..........b........b....b.......b...................................................................",
                    "..........b........b....b.......b.............................bbbbbbbbbbb...........................",
                    "..........b........b....b.......b...........................bbb.........bbbb........................",
                    "..........b........b....bb......b..........................bb...............b.......................",
                    "..........b........b.....b......bb.......................bbb.................bb.....................",
                    "..........b........b.....b.......bbbb...................bb....................bbb...................",
                    "..........b........b.....b..........bbbbbbbbbbbbbbbbbbbbb.......................bb..................",
                    ".........b........b......b.......................................................bbb................",
                    ".......bb.........b......b.........................................................bb...............",
                    ".......b.........bb......bb.........................................bbbbbb..........b...............",
                    ".......b.........b........b...................................bbbbbbb....bbbb........b..............",
                    ".......b.......bb.........bb...............................bbbb.............bb.......b..............",
                    ".......b.......b............bbbbb.......................bbbb.................bb.......b.............",
                    ".......b......b.................bbbbbbbbbbbbbbbbbbbbbbbbb.....................b.......b.............",
                    ".......b......b...............................................................b.......bb............",
                    ".......b......b..................bbbbbb.......................................b........b............",
                    ".......b......b.............bbbbbb....bbbbbb..................................b........b............",
                    ".......b......b.......bb..bbb...............bbb...............................b........b............",
                    ".......b.......bbb..bbbbbbb...................bbbb...........................bb........b............",
                    ".......b.........bbbb............................bbbb.......................bb.........b............",
                    "........b...........................................bb.....................bb..........b............",
                    "........b............................................bbb.................bb...........bb............",
                    "........b.........................bbbbbbbb.............bb...........bbbbb............bb.............",
                    "........bb.....................bbbb......bbb............bbbbbbbbbbbb.................b..............",
                    ".........bb.................bbbb...........bb......................................bbb..............",
                    "..........bbbb.......bbbbbbbb...............b....................................bbb................",
                    "..............bbbbbbbb......................bb.................................bbb..................",
                    ".............................................b................................bbb...................",
                    "..............................................bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb....................",
                    "....................................................................................................",
                ],
                0,
                0,
                tileSize,
                tileSize
            );
            player.direction = 0
            break
        case "3":
            new Tiles(
                [
                    "....................................................................................................",
                    ".......bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb............................................................",
                    "......bBBBBBBBBBBBBBBBBBBBBBBBBBBBBBSBBbbb..........................................................",
                    ".....bBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBSBBBBbbb........................................................",
                    "....bBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBSBBBBBBbb.......................................................",
                    "...bBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBSBBBBBBBb.......................................................",
                    "..bBBBBBBBBBBbbbbbbbbbbbbbbbbbbbbbbbbbbBBBBBbbbbbbbbbbbbbbbbbb......................................",
                    "..bBBBBBBbbbbb......................s..........BBBBBBBbbBBBBBbb.....................................",
                    "..bBBBBbb...........................s...........BBBBBBBbBBBBBBbb....................................",
                    "..bB................................s...........BBBBBBBBBBBBBBBbbbbbbbbbbbbbbbbb....................",
                    ".b..................................s...........BBBbBBBBBBbBBB.................bbb..................",
                    ".b..........................x.......s...........BBbbBBBBBbbBB....................bbb................",
                    ".b..................................s...........bbbbbbbbbbbb.......................bb...............",
                    "bb........................bbbbbbbbbbs...........b.......bbb.........................bb..............",
                    "b................bbbbbbbbbb........bbbbbbbb.....bb....bbb............................bb.............",
                    "b............bbbbb........................b......b...bb.........bbbbbbbbbbbb..........b.............",
                    "b.........bbbb............................b......bb.bb.........bb..........bbb........bb............",
                    "b........bb...............................b.......bbb.......bbbb.............bb........bb...........",
                    "b........b................................bb...............bb.................bb........b...........",
                    "bb......bb.................................b..............bb...................bb.......bb..........",
                    ".b......bb.................................bbb............b.....................bb.......bb.........",
                    ".b.......b...................................bb.........bbb......................b........b.........",
                    ".b.......bb...................................bbb.....bbb........................bb.......bb........",
                    ".b........bb....................................bbbbbbb...........................b........b........",
                    ".b.........bb.....................................................................bb.......bb.......",
                    ".b..........bb.....................................................................b........b.......",
                    "..b..........bbb....................................................................b.......bb......",
                    "..bb...........bb...................................................................bb.......b......",
                    "...b.............bb..................................................................b.......b......",
                    "...bb.............bb.................................................................bb......bb.....",
                    "....b..............bb.................................................................b.......b.....",
                    "....bb..............bb..............bbbbbb............................................bb......bb....",
                    ".....bb..............bb...........bbb....bbbb..........................................b.......b....",
                    "......bb..............b..........bb.........bb.........................................b.......b....",
                    ".......bb..............b.......bbb...........b.........................................b........b...",
                    "........bb.............b.......b.............bb........................................b........b...",
                    ".........bb............b......bb..............b........................................b........b...",
                    "..........b............b.....bb...............bb.......................................b........b...",
                    ".........b.............b....bb.................bb......................................b........b...",
                    "........bb............bb....b...................bb....................................bb........b...",
                    "........b............bb....bb....................bb...................................b.........b...",
                    ".......b............bb.....b......................bb..................................b.........b...",
                    "......bb...........bb......b........................bb................................b.........b...",
                    "......b...........bb......bb.........................bb...............................b.........b...",
                    ".....bb..........bb.......b...........................bb.............................bb.........b...",
                    ".....b...........b.......bb............................bb............................b..........b...",
                    ".....b..........bb.......b..........bbbbbbb.............b............................b..........b...",
                    "....b...........b........b.........bb.....b.............bb..........................bb.........bb...",
                    "....b..........bb.......bb.........b......b..............b..........................b..........b....",
                    "....b..........b........b..........b......bb.............bb......................bbb...........b....",
                    "....b..........b........b..........b.......b..............b...................bbbb............bb....",
                    "...b...........b........b..........b.......b..............b.................bbb..............bb.....",
                    "...b...........b.......bb..........b.......bb..............b...............bb...............bb......",
                    "...b...........b.......b...........b........b..............b..............bb...............bb.......",
                    "..b............b.......b...........b........b..............b..............b.............bbbb........",
                    "..b............b......bb...........b........bb.............b..............b.......bbbbbbb...........",
                    "..b............b......b............b.........b.............bb.............b......bb.................",
                    "..b............b......b............b.........b..............b.............b......b..................",
                    "..b............b......b............b..........b.............b.............b......b..................",
                    "..b............b......b.............b.........b.............b.............bb.....b..................",
                    "..b............b......b.............b.........bb............b..............b.....bb.................",
                    "..b............b......b.............b..........b............b..............b......bb................",
                    "..bb...........b......b.............b..........bb...........b...............b......bb...............",
                    "...b...........b......b..............b..........b...........b...............b.......bb..............",
                    "...b...........bb.....b..............b..........b...........b...............bb.......bbb............",
                    "...bb...........b.....b..............b..........b...........b................b.........bb...........",
                    "....b...........b....bb..............b...........b..........b................bb.........bb..........",
                    "....b...........b....b...............b...........b..........b.................b..........bb.........",
                    "....b...........b....b...............b...........b..........b.................bb..........bb........",
                    ".....b..........bb...b...............b...........bb..........b.................bb..........bb.......",
                    ".....b...........b...b...............b............b..........b..................bb..........b.......",
                    "......b..........b...b...............b............b..........b...................bb.........bb......",
                    "......b..........bb..b...............b............bb.........b....................b..........b......",
                    "......bb..........bbbb...............b.............b.........b....................bb.........b......",
                    ".......b.............................b..............b........b.....................bb........bb.....",
                    ".......bb............................b...............b.......b......................b.........b.....",
                    "........b............................b...............bb......b......................b.........b.....",
                    "........b............................b................b......b......................b.........b.....",
                    ".........b...........................b................b......b......................b.........b.....",
                    ".........b..........................bb................bttttttbb.....................b........b......",
                    ".........bb.........................b.................bb......b.....................b........b......",
                    "..........b.......................bbb..................b......b.....................b........b......",
                    "..........b......................bb....................b......b....................bb........b......",
                    "...........b...................bbb.....................bb.....bb..................bb........bb......",
                    "...........bb..............bbbbb........................b......bbb........bbbbbbbbb.........b.......",
                    ".............bbbbbbbbbbbbbbb............................b........bbbbbbbbbb.................b.......",
                    "........................................................bb..................................b.......",
                    ".........................................................b.................................bb.......",
                    ".........................................................bb...............................bb........",
                    "..........................................................bb.............................bb.........",
                    "...........................................................bb...........................bb..........",
                    "............................................................bb........................bbb...........",
                    ".............................................................bb.....................bbb.............",
                    "..............................................................bb..............bbbbbbb...............",
                    "................................................................bbbbbbbbbbbbbbb.....................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                ],
                0,
                0,
                tileSize,
                tileSize
            )
            break
        case "4":
            new Tiles(
                [
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    ".................................................................bbbbbbbbbbb........................",
                    "..............................................................bbbb.........bb.......................",
                    "..........................................................bbbbb.............bb......................",
                    ".........................................................bb..................b......................",
                    ".......................................................bbb...................bb.....................",
                    "......................................................bb......................b.....................",
                    ".....................................................bb...........bbbbbb......b.....................",
                    "...................................................bbb...x.......bb....bb.....b.....................",
                    "..................................................bb.ss.........b.......b.....b.....................",
                    ".................................................bb...ss.......bb.......b.....b.....................",
                    "................................................bb.....ss...bbb........bb......b....................",
                    "...............................................bb.......ss..b........bbb......bb....................",
                    "..............................................bb.........ss.bbbbbbbbbb........b.....................",
                    ".............................................bb...........bbb.................b.....................",
                    "............................................bb...........bb...................b.....................",
                    "...........................................bb............b....................b.....................",
                    "..........................................bb............bb...................bb.....................",
                    "..........................................b............bb...................bb......................",
                    ".........................................bb...........bb.................bbb........................",
                    "........................................bb............b............bbbbbbb..........................",
                    ".......................................bb............b..........bbbb................................",
                    ".......................................b............bb.........bb...................................",
                    "......................................b............bb.........bb....................................",
                    ".....................................bb............b.........bb.....................................",
                    ".....................................b............b.........bb......................................",
                    "....................................bb...........bb.........b.......................................",
                    "....................................b...........bb.........bb.......................................",
                    "...................................bb...........b.........bb........................................",
                    "...................................b...........bb.........b.........................................",
                    "..................................b...........bb.........b..........................................",
                    ".................................bb...........b.........bb..........................................",
                    ".................................b...........bb........bb...........................................",
                    "................................b...........bb.........b............................................",
                    "...............................bb..........bb.........b.............................................",
                    "...............................b...........b.........bb.............................................",
                    "..............................bb..........bb........bb..............................................",
                    "..............................b..........bb.........b...............................................",
                    ".............................b..........bb.........b................................................",
                    ".............................b..........b.........bb................................................",
                    "............................bb.........b.........bb.................................................",
                    "............................b.........bb........bb..................................................",
                    "...........................bb.........b........bb...................................................",
                    "...........................b.........bb........b....................................................",
                    "..........................bb........bb........bb....................................................",
                    "..........................b........bb........bb.....................................................",
                    ".........................b........bb.........b......................................................",
                    ".........................b........b.........bb......................................................",
                    "........................b........b.........bb.......................................................",
                    ".......................bb.......bb.........b........................................................",
                    ".......................b........b.........bb........................................................",
                    ".......................b.......bb.........b.........................................................",
                    "......................bb.......b.........bb.........................................................",
                    ".....................bb.......b..........b..........................................................",
                    "....................bb.......bb.........bb..........................................................",
                    "...................bb........b.........bb...........................................................",
                    "..................bb........bb........bb............................................................",
                    ".................bb.........b.........b.............................................................",
                    "................bb.........b.........b..............................................................",
                    "................b.........bb........b...............................................................",
                    "...............bb.........b.........b...............................................................",
                    "..............bb.........bb........bb...............................................................",
                    ".............bb..........b.........b................................................................",
                    "...........bbb..........b..........b................................................................",
                    ".........bbb...........bb........bb.................................................................",
                    "........bb............bbt.......b...................................................................",
                    ".....bbb..............b..ttt....b...................................................................",
                    ".....b...............b.....ttt.bb...................................................................",
                    ".....b..............bb.......tbb....................................................................",
                    ".....b.............b..........b.....................................................................",
                    ".....b...........bb...........b.....................................................................",
                    ".....b..........bb............b.....................................................................",
                    ".....b......bbbbb............bb.....................................................................",
                    ".....b.......................b......................................................................",
                    ".....b......................b.......................................................................",
                    ".....bb....................bb.......................................................................",
                    "......bb...................b........................................................................",
                    ".......bb.................bb........................................................................",
                    "........bbb..............bb.........................................................................",
                    "...........bbbb.......bbbb..........................................................................",
                    "..............bbbbbbbbb.............................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                ],
                0,
                0,
                tileSize,
                tileSize

            )
            player.rotation = 135
            break
    }
    // Create Tiles from Tile map depending on the input

}

function draw() {
    clear()
    SlowZone()
    background("#5a5348")
    let fps = 60
    camera.on()
    camera.zoom = 3
    camera.x = player.x
    camera.y = player.y
    camera.on()
    controls()
    laptime += 1 / fps
    if (timeRemaining > 0) {
        timeRemaining -= 1 / fps
    } else {
        if (countdown > 0) {
            countdown--
        } else {
            endGame = true
        }
    }

    //console.log(laptime)
    //text(laptime, 0, 0)
    if (lapStarted) {
        player.color = "green"
    }
    trackLimit.draw()
    track.draw()
    camera.off()
    
    rect(width - 350, height - 100, width, height, 20, 0, 0, 0)
    textAlign(LEFT, TOP)
    textFont('Titillium Web')
    textStyle(BOLD)
    textSize(24)
    if (fastestLap) {
        rect(0, 0, 250, 125, 0, 0, 20, 0)
        text(`Lap: ${lap}\nRemaining: ${floor(timeRemaining/60)}:${floor(timeRemaining%60)}\nTime: ${floor(laptime/60)}:${(laptime%60).toFixed(3)}\nFastest: ${floor(fastestLap/60)}:${(fastestLap%60).toFixed(3)} (${fastestOnLap})`, 10, 10)
    } else {
        rect(0, 0, 250, 100, 0, 0, 20, 0)
        text(`Lap: ${lap}\nRemaining: ${floor(timeRemaining/60)}:${floor(timeRemaining%60)}\nTime: ${floor(laptime/60)}:${(laptime%60).toFixed(3)}`, 10, 10)
    }
    text(`Speed: ${floor(player.speed * 30)}MPH`, width - 340, height - 85)
    if (endGame){
        setTimeout(() => {
            window.sessionStorage.setItem(times, qLaps)
            window.sessionStorage.setItem(track, mapSelected)
            window.location.assign("Race.html")
            // window.location.assign("Main_Menu.html")

        }, 10000);
    }
}

function controls() {
    //Check whether the user has a gamepad connected
    if (contros[0]) {
        if (contro.pressing("rightTrigger") && !endGame) {
            if (slowed) {
                if (player.speed < 1) {
                    player.speed += (20 / 120)
                }
            } else {
                if (player.speed < 3) {
                    player.speed += (45 / 120)
                }
            }
            player.direction = player.rotation;
        }
        let direction = Math.atan2(contro.leftStick.y, contro.leftStick.x)
        player.rotation = (direction * 180) / Math.PI
        player.direction = player.rotation
        if (contro.pressing("leftTrigger")) {
            player.drag = 10;
            player.friction = 10;
            player.direction = player.rotation;
        } else {
            player.drag = 5;
            player.friction = 5;
        }
        if (contro.presses('a') && gear < 6) {
            gear++
        }
        if (contro.presses('b') && gear > 1) {
            gear--
        }
    } else {
        if (kb.presses("w") && !endGame) {
            player.speed = 0.5
        }
        if (kb.pressing("w") && !endGame) {
            if (slowed) {
                if (player.speed < 1) {
                    player.speed += (20 / 120)
                }
            } else {
                if (player.speed < 3) {
                    player.speed += (45 / 120)
                }
            }
            player.direction = player.rotation;

        }

        if (kb.pressing("s")) {
            player.drag = 10;
            player.friction = 10;
            player.direction = player.rotation;
        } else {
            player.drag = 5
            player.friction = 5

        }
        if (kb.presses("shift")) {
            hasStalled = false
        }
        if (kb.pressing("a")) {
            console.log(UndersteerCalc(player.speed, -3, "Left"))
            player.rotate(UndersteerCalc(player.speed, -3, "Left"), 3);
            player.direction = player.rotation;
        }
        if (kb.pressing("d")) {
            console.log(UndersteerCalc(player.speed, 3, "Right"))
            player.rotate(UndersteerCalc(player.speed, 3, "Right"), 3);
            player.direction = player.rotation;
        }
        if (kb.presses('arrowUp') && gear < 6) {
            gear++
            console.log("shift up")
        }
        if (kb.presses('arrowDown') && gear > 1) {
            gear--
            console.log("shift down")
        }
        if (kb.presses("escape")) {
            timestartheld = PST
        }
        if (kb.pressing("escape")) {
            if (PST - timestartheld > 3) {
                sessionComplete = true
            }
        }

    }
    if (player.collides(trackLimit) && player.speed > 2) {
        //hasStalled = true
    }

}

function StartLineOverlap() {
    if (!sessionStarted) {
        sector = 1
        sessionStarted = true
        laptime = 0
        lapStarted = true
        player.color = 'blue'
    }
    if (!lapStarted && !sessionComplete) {
        lapStarted = true
        qLaps[lap] = laptime
        lap++
        FastestLapCalculation(laptime)
        laptime = 0
    }
    if (timeRemaining <= 0) {
        sessionComplete = true
    }
    if (!lapStarted && sessionComplete) {
        qLaps[lap] = laptime
        lap++
        FastestLapCalculation(laptime)
        laptime = 0
        endGame = true
    }
}

function TimingOverlap() {
    lapStarted = false
    sector = 2
}

/**
 * @param {Float} prevLap - The laptime given as a comparison to the fastest lap
 */

function FastestLapCalculation(prevLap) {

    if (fastestLap) {
        if (prevLap < fastestLap) {
            fastestLap = prevLap
            fastestOnLap = lap - 1
        }
    } else {
        fastestLap = prevLap
    }
}


/**
 * @param {Float} speed - The current speed of the player
 * @param {Integer} sensitivity - The set sensitivity of the player controller
 * @param {String} direction - The direction the player wants to turn
 * @returns {Float} - The speed of which the player will turn
 */



function UndersteerCalc(speed, sensitivity, direction) {
    let turnSpeed, finalsensitivity
    if (speed > 1) {
        if (direction == "Left") {
            turnSpeed = -1 * (abs(sensitivity) - (speed - 1) / 3)
            return turnSpeed
        } else {
            turnSpeed = (abs(sensitivity) - (speed - 1) / 3)
            return turnSpeed
        }
    } else {
        if (direction == "Left") {
            finalsensitivity = sensitivity
            return finalsensitivity
        } else {
            finalsensitivity = sensitivity
            return finalsensitivity
        }
    }
}

function SlowZone() {
    if (player.overlaps(slowArea) || player.overlaps(startSlowArea)) {
        slowed = true
    } else {
        slowed = false
    }
}
